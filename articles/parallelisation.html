<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parallelisation of inference • mcstate</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parallelisation of inference">
<meta property="og:description" content="mcstate">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcstate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/kalman.html">Validation of SMC using a Kalman filter</a>
    </li>
    <li>
      <a href="../articles/nested_sir_models.html">Nested SIR Models</a>
    </li>
    <li>
      <a href="../articles/parallelisation.html">Parallelisation of inference</a>
    </li>
    <li>
      <a href="../articles/restart.html">Restarting pMCMC</a>
    </li>
    <li>
      <a href="../articles/sir_models.html">SIR models with odin, dust and mcstate</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/mcstate/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="parallelisation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parallelisation of inference</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/mcstate/blob/master/vignettes/parallelisation.Rmd"><code>vignettes/parallelisation.Rmd</code></a></small>
      <div class="hidden name"><code>parallelisation.Rmd</code></div>

    </div>

    
    
<p>In the SIR model vignette we ran four separate MCMC chains in serial. For more computationally intensive models you can speed this up if you have many CPU cores available.</p>
<div id="within-model-parallelism" class="section level2">
<h2 class="hasAnchor">
<a href="#within-model-parallelism" class="anchor"></a>Within-model parallelism</h2>
<p>Because <code>mcstate</code> uses <code>dust</code>, it can run each particle in parallel, between the timesteps that you have data for. For this to be possible, <code>openmp</code> must be enabled in the compilation step, which you can check by using the <code>has_openmp()</code> method on your model:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span><span class="op">$</span><span class="va">public_methods</span><span class="op">$</span><span class="fu">has_openmp</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<p>When constructing the particle filter object, you must specify the <code>n_threads</code> argument, for example to use 4 threads:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va"><a href="../reference/particle_filter.html">particle_filter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>,
                                       model <span class="op">=</span> <span class="va">model</span>,
                                       n_particles <span class="op">=</span> <span class="fl">100</span>,
                                       compare <span class="op">=</span> <span class="va">compare</span>,
                                       n_threads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p>When you pass this filter object through to <code>mcstate::mcmc</code>, the particle filter will then run using 4 threads.</p>
<p>You can wrap this <code>n_threads</code> argument with <code><a href="https://rdrr.io/pkg/dust/man/dust_openmp_threads.html">dust::dust_openmp_threads</a></code>, for example</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dust/man/dust_openmp_threads.html">dust_openmp_threads</a></span><span class="op">(</span><span class="fl">100</span>, action <span class="op">=</span> <span class="st">"fix"</span><span class="op">)</span>
<span class="co">#&gt; Requested number of threads '100' exceeds a limit of '1'</span>
<span class="co">#&gt;  See dust::dust_openmp_threads() for details</span>
<span class="co">#&gt; [1] 1</span></code></pre></div>
<p>which will adjust the number of threads used (alternative actions include “message” or “error”).</p>
</div>
<div id="between-chain-parallelism" class="section level2">
<h2 class="hasAnchor">
<a href="#between-chain-parallelism" class="anchor"></a>Between-chain parallelism</h2>
<p>If your model is quick to run, like the SIR example, it may be more efficient to use cores to run parallel <em>chains</em> instead of parallel particles. This is because relatively little time is spent in the parallelised fraction of the code, and more in the serial parts (the mcmc bookkeeping, your compare functions in the particle filter, copying data between the R and C++ interface; basically anything other than the number crunching in the core of the model).</p>
<p>We can do this by passing the <code>n_workers</code> argument to <code><a href="../reference/pmcmc_control.html">mcstate::pmcmc_control</a></code>; this will create separate worker processes and share chains out across them. You can have fewer workers than chains, and each worker can use more than one core if needed (subject to a few constraints documented in the help page).</p>
<p>In this case, the number of threads used to create the particle filter is <em>ignored</em> (because the particle filter will be created on each process) and the total number of threads to use should be provided by the <code>n_threads_total</code> argument to <code><a href="../reference/pmcmc_control.html">mcstate::pmcmc_control</a></code>.</p>
<p>For example, if you had 16 cores available, running 4 chains over 2 workers, each using 8 cores you might write:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_control.html">pmcmc_control</a></span><span class="op">(</span><span class="fl">1000</span>, n_chains <span class="op">=</span> <span class="fl">4</span>, n_workers <span class="op">=</span> <span class="fl">2</span>,
                                  n_threads_total <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></code></pre></div>
<p>or, if your system does not support OpenMP you could use 4 workers for these chains:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_control.html">pmcmc_control</a></span><span class="op">(</span><span class="fl">1000</span>, n_chains <span class="op">=</span> <span class="fl">4</span>, n_workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p>If your system <em>does</em> support OpenMP, then once chains start finishing their threads will be allocated to the ongoing chains.</p>
<p>The random numbers are configured in such a way that the final result will be dependent only on the seed to create your <code>filter</code> object and not the number of worker processes or threads used. However, the algorithm does differ slightly by default to that used without workers. To use this parallel behaviour even when <code>n_workers</code> is 1, set <code>use_parallel_seed = TRUE</code> within <code><a href="../reference/pmcmc_control.html">mcstate::pmcmc_control</a></code>.</p>
</div>
<div id="considerations" class="section level2">
<h2 class="hasAnchor">
<a href="#considerations" class="anchor"></a>Considerations</h2>
<p>Parallelism at the level of particles (increasing the number of threads available to the particle filter) has very low overhead and is potentially very efficient as the “serial” part of the calculation here is just the comparison functions. On Linux we see linear scaling of performance with cores; i.e., that if you double the number of cores you halve the running time.</p>
<p>However, on Windows we do not realise this level of efficiency (for reasons under investigation). In that case you will want to use multiple worker processes; these are essentially isolated from each other and on windows can lead to higher efficiencies. You should only need 2-4 worker processes in order to use 100% of your CPU, with the total number of threads set to the number of cores you have available. This approach may take a few seconds longer over the whole run than a perfectly efficient run, but potentially significantly less time than the realised efficiency we see on windows.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rich FitzJohn, Marc Baguelin, Edward Knock, Lilith Whittles, John Lees, Raphael Sonabend.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
