<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restarting pMCMC • mcstate</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Restarting pMCMC">
<meta property="og:description" content="mcstate">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcstate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/deterministic.html">Deterministic models</a>
    </li>
    <li>
      <a href="../articles/if2.html">Inference with iterated filtering</a>
    </li>
    <li>
      <a href="../articles/kalman.html">Validation of SMC using a Kalman filter</a>
    </li>
    <li>
      <a href="../articles/nested_sir_models.html">Nested SIR Models</a>
    </li>
    <li>
      <a href="../articles/parallelisation.html">Parallelisation of inference</a>
    </li>
    <li>
      <a href="../articles/restart.html">Restarting pMCMC</a>
    </li>
    <li>
      <a href="../articles/sir_models.html">SIR models with odin, dust and mcstate</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/mcstate/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="restart_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Restarting pMCMC</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/mcstate/blob/master/vignettes/restart.Rmd"><code>vignettes/restart.Rmd</code></a></small>
      <div class="hidden name"><code>restart.Rmd</code></div>

    </div>

    
    
<p>We are experimenting with an ability to “restart” the simulation at a point in time based on the outcome of a MCMC run. The motivating reason to do this is in our <a href="https://mrc-ide.github.io/sircovid/"><code>sircovid</code></a> model where run an epidemiological model with a number of time varying parameters corresponding to interventions which leads to a number of “waves” of infections. We want to be able to restart the simulation from the trough between two waves so that we can avoid refitting the first peak and better capture changes in parameters as the epidemic unfolds.</p>
<p>To illustrate this problem and the solution we will use a much simpler model which does not show recurrent waves of infection, so we will contrive points to restart. This example picks up from the <code><a href="../articles/sir_models.html">vignette("sir_models")</a></code> vignette.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">incidence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"sir_incidence.csv"</span>, package <span class="op">=</span> <span class="st">"mcstate"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">day</span>, <span class="va">incidence</span>,
     type <span class="op">=</span> <span class="st">"o"</span>, xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"New cases"</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p><img src="restart_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"sir_true_history.rds"</span><span class="op">)</span>
<span class="va">history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html">drop</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"cases"</span><span class="op">)</span>
<span class="va">history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span>, <span class="va">history</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">history</span><span class="op">$</span><span class="va">t</span>, <span class="va">history</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>,
        xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Variable"</span><span class="op">)</span></code></pre></div>
<p><img src="restart_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sir</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dust/man/dust_example.html">dust_example</a></span><span class="op">(</span><span class="st">"sir"</span><span class="op">)</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.25</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/particle_filter_data.html">particle_filter_data</a></span><span class="op">(</span><span class="va">incidence</span>, time <span class="op">=</span> <span class="st">"day"</span>, rate <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">dt</span><span class="op">)</span></code></pre></div>
<p>A comparison function</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compare</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">observed</span>, <span class="va">pars</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">cases</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">exp_noise</span> <span class="op">&lt;-</span> <span class="fl">1e6</span>
  <span class="va">incidence_modelled</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">1</span>, , drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>
  <span class="va">incidence_observed</span> <span class="op">&lt;-</span> <span class="va">observed</span><span class="op">$</span><span class="va">cases</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">incidence_modelled</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">incidence_modelled</span><span class="op">)</span>, rate <span class="op">=</span> <span class="va">exp_noise</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">dpois</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">incidence_observed</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>An index function for filtering the run state</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">index</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">info</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>run <span class="op">=</span> <span class="fl">5L</span>, state <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Parameter information for the pMCMC, including a roughly tuned kernel so that we get adequate mixing</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">proposal_kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.00057</span>, <span class="fl">0.00034</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.00034</span>, <span class="fl">0.00026</span><span class="op">)</span><span class="op">)</span>
<span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va"><a href="../reference/pmcmc_parameters.html">pmcmc_parameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_parameter.html">pmcmc_parameter</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="fl">0.2</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span>,
                                prior <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1e-10</span><span class="op">)</span><span class="op">)</span>,
       <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_parameter.html">pmcmc_parameter</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="fl">0.1</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span>,
                                prior <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1e-10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
  proposal <span class="op">=</span> <span class="va">proposal_kernel</span><span class="op">)</span></code></pre></div>
</div>
<div id="all-in-one" class="section level2">
<h2 class="hasAnchor">
<a href="#all-in-one" class="anchor"></a>All-in-one</h2>
<p>Run a pMCMC with 100 particles for the full length of the data. This means that we are fitting to the entire series.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_particles</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va"><a href="../reference/particle_filter.html">particle_filter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">data</span>, <span class="va">sir</span>, <span class="va">n_particles</span>, <span class="va">compare</span>,
                                   index <span class="op">=</span> <span class="va">index</span>,
                                   n_threads <span class="op">=</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dust/man/dust_openmp_threads.html">dust_openmp_threads</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">control1</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_control.html">pmcmc_control</a></span><span class="op">(</span><span class="fl">500</span>, save_trajectories <span class="op">=</span> <span class="cn">TRUE</span>,
                                   save_state <span class="op">=</span> <span class="cn">TRUE</span>, save_restart <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>
<span class="va">res1</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc.html">pmcmc</a></span><span class="op">(</span><span class="va">pars</span>, <span class="va">p1</span>, control <span class="op">=</span> <span class="va">control1</span><span class="op">)</span></code></pre></div>
<p>Here’s the trajectories showing the number of people infected</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">t</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">trajectories</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>,
        col <span class="op">=</span> <span class="st">"#00000011"</span>, xlab <span class="op">=</span>  <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Infected"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">I</span> <span class="op">~</span> <span class="va">t</span>, <span class="va">history</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></code></pre></div>
<p><img src="restart_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>And the daily incidence</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">t</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">trajectories</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="fl">5</span>, , <span class="op">]</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>,
        lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000005"</span>, xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Daily incidence"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">day</span>, <span class="va">incidence</span>, col <span class="op">=</span> <span class="st">"blue"</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p><img src="restart_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
</div>
<div id="restarting" class="section level2">
<h2 class="hasAnchor">
<a href="#restarting" class="anchor"></a>Restarting</h2>
<p>In the <code><a href="../reference/pmcmc_control.html">mcstate::pmcmc_control</a></code> call above we added <code>save_restart = 40</code>; this means that we save the entire internal state of a single particle at time step 40 (this is the “day” time, not the model step).</p>
<p>The restart state is a 3d array with dimensions corresponding to (1) model state, (2) MCMC sample, (3) restart time (a vector of times can be provided to <code>save_restart</code> but here just one time was returned).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">restart</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>
<span class="co">#&gt; [1]   5 501   1</span></code></pre></div>
<p>This sample includes variablility over the pmcmc run:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">restart</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">]</span>, xlab <span class="op">=</span> <span class="st">"Number infected"</span>,
     main <span class="op">=</span> <span class="st">"Distribution of number infected over mcmc samples"</span><span class="op">)</span></code></pre></div>
<p><img src="restart_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>This matrix includes all information to restart the stochastic process and we can use this to run a pmcmc that starts the particle filter that runs over data starting from day 40. Note that this is <em>not</em> the same model as it does fit to the first 40 days of the epidemic so we expect parameters to differ (it’s a bit like allowing a break in parameters at day = 40 except our initial parameter sets here <em>do</em> include both parts.</p>
<p>The key part is to create an <code>initial</code> function for the particle function that will create suitable initial conditions. We do this by sampling <code>n_particles</code> worth of particles out of this matrix. (The <code>initial</code> function must conform to mcstate’s interface so we accept <code>info</code> and <code>pars</code> here even though we ignore them)</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">res1</span><span class="op">$</span><span class="va">restart</span><span class="op">$</span><span class="va">state</span><span class="op">[</span>, , <span class="fl">1</span><span class="op">]</span>
<span class="va">initial</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">info</span>, <span class="va">n_particles</span>, <span class="va">pars</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>state <span class="op">=</span> <span class="va">s</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span>, <span class="va">n_particles</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Then subset the data that we will fit to and create a new particle filter</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data2</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">day_start</span> <span class="op">&gt;=</span> <span class="fl">40</span>, <span class="op">]</span>
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va"><a href="../reference/particle_filter.html">particle_filter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">data2</span>, <span class="va">sir</span>, <span class="va">n_particles</span>, <span class="va">compare</span>,
                                   index <span class="op">=</span> <span class="va">index</span>, initial <span class="op">=</span> <span class="va">initial</span>,
                                   n_threads <span class="op">=</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dust/man/dust_openmp_threads.html">dust_openmp_threads</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>And run a pMCMC that fits parmeters to the second half of the epidemic</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">control2</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_control.html">pmcmc_control</a></span><span class="op">(</span><span class="fl">500</span>, save_trajectories <span class="op">=</span> <span class="cn">TRUE</span>,
                                   save_state <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">res2</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc.html">pmcmc</a></span><span class="op">(</span><span class="va">pars</span>, <span class="va">p2</span>, control <span class="op">=</span> <span class="va">control2</span><span class="op">)</span></code></pre></div>
<p>Plot of the number of people infected over time with the overall model (black) and the restarted model (red) with observed data (blue)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>
<span class="va">t2</span> <span class="op">&lt;-</span> <span class="fl">40</span><span class="op">:</span><span class="fl">100</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">t</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">trajectories</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>,
        col <span class="op">=</span> <span class="st">"#00000005"</span>, xlab <span class="op">=</span>  <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Infected"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">t2</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">res2</span><span class="op">$</span><span class="va">trajectories</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">]</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>,
         col <span class="op">=</span> <span class="st">"#ff000011"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">I</span> <span class="op">~</span> <span class="va">t</span>, <span class="va">history</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></code></pre></div>
<p><img src="restart_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>Daily incidence, which is what the model actually fits to</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">t</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">trajectories</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="fl">4</span>, , <span class="op">]</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>,
        lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000002"</span>, xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Daily incidence"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">t2</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">res2</span><span class="op">$</span><span class="va">trajectories</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="fl">4</span>, , <span class="op">]</span><span class="op">)</span><span class="op">)</span>,
        lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#ff000005"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">day</span>, <span class="va">incidence</span>, col <span class="op">=</span> <span class="st">"blue"</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p><img src="restart_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>The parameter estimates, which are a similar but not identical distribution</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">pars</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">pars</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">res2</span><span class="op">$</span><span class="va">pars</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">pars</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">res2</span><span class="op">$</span><span class="va">pars</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>,
     col <span class="op">=</span> <span class="st">"#0000ff55"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">res2</span><span class="op">$</span><span class="va">pars</span>, col <span class="op">=</span> <span class="st">"#ff000055"</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p><img src="restart_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rich FitzJohn, Marc Baguelin, Edward Knock, Lilith Whittles, John Lees, Raphael Sonabend.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
