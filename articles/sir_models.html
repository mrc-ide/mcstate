<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIR models with odin, dust and mcstate • mcstate</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SIR models with odin, dust and mcstate">
<meta property="og:description" content="mcstate">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcstate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.11</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/kalman.html">Validation of SMC using a Kalman filter</a>
    </li>
    <li>
      <a href="../articles/nested_sir_models.html">Nested SIR Models</a>
    </li>
    <li>
      <a href="../articles/parallelisation.html">Parallelisation of inference</a>
    </li>
    <li>
      <a href="../articles/restart.html">Restarting pMCMC</a>
    </li>
    <li>
      <a href="../articles/sir_models.html">SIR models with odin, dust and mcstate</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/mcstate/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="sir_models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="sir_models_files/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="sir_models_files/pagedtable-1.1/js/pagedtable.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SIR models with odin, dust and mcstate</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/mcstate/blob/master/vignettes/sir_models.Rmd"><code>vignettes/sir_models.Rmd</code></a></small>
      <div class="hidden name"><code>sir_models.Rmd</code></div>

    </div>

    
    
<p><code>mcstate</code> sits at the top of a stack of packages, which together allow inference of a stochastic model’s parameters by fitting to a time-series of observational data. To use <code>mcstate</code>, we require the following pieces:</p>
<ul>
<li>A generative model for a state-space process, implemented in <a href="https://mrc-ide.github.io/dust/"><code>dust</code></a>. This will generate (stochastic) updates of the state at each time step.</li>
<li>A time-series of observed data, which may include from multiple sources (e.g. cases, hospital beds, deaths).</li>
<li>A comparison function, which calculates the likelihood of a model state, given the observed data.</li>
<li>Optionally an index function, which identifies the indices of the state used to compute the comparison. This is particularly useful when the state space is large, and only a small number of states are used in the comparison function.</li>
</ul>
<p>Below we describe a typical use case for infectious disease: given daily case counts during an epidemic, how can we estimate key features of the transmission process such as the transmission rate, recovery rate and from these the basic reproductive number <span class="math inline">\(R_0\)</span>.</p>
<div id="stochastic-sir-model-definition" class="section level1">
<h1 class="hasAnchor">
<a href="#stochastic-sir-model-definition" class="anchor"></a>Stochastic SIR model definition</h1>
<p>A simple definition of the SIR model, as given in the <a href="https://mrc-ide.github.io/odin/articles/discrete.html">odin documentation</a> is: <span class="math display">\[\begin{align*}
\frac{dS}{dt} &amp;= -\beta \frac{SI}{N} \\
\frac{dI}{dt} &amp;= \beta \frac{SI}{N} - \gamma I \\
\frac{dR}{dt} &amp;= \gamma I \\
\end{align*}\]</span> <span class="math inline">\(S\)</span> is the number of susceptibles, <span class="math inline">\(I\)</span> is the number of infected and <span class="math inline">\(R\)</span> is the number recovered; the total population size <span class="math inline">\(N = S + I + R\)</span> is constant. <span class="math inline">\(\beta\)</span> is the infection rate, <span class="math inline">\(\gamma\)</span> is the recovery rate.</p>
<p>Discretising this model in time steps of width <span class="math inline">\(dt\)</span> gives the following update equations for each time step:</p>
<p><span class="math display">\[\begin{align*}
S_{t+1} &amp;= S_t - n_{SI} \\
I_{t+1} &amp;= I_t + n_{SI} - n_{IR} \\
R_{t+1} &amp;= R_t + n_{IR}
\end{align*}\]</span></p>
<p>where <span class="math display">\[\begin{align*}
n_{SI} &amp;\sim B(S, 1 - e^{-\beta \frac{I}{N} \cdot dt}) \\
n_{IR} &amp;\sim B(I, 1 - e^{-\gamma \cdot dt})
\end{align*}\]</span></p>
<p>This example is included with the <code>dust</code> package, and can be loaded with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen_sir</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dust/man/dust_example.html">dust_example</a></span><span class="op">(</span><span class="st">"sir"</span><span class="op">)</span></code></pre></div>
<p>To learn how to implement this yourself, see the vignette over at <a href="https://mrc-ide.github.io/odin.dust/"><code>odin.dust</code></a>.</p>
</div>
<div id="inferring-parameters-with-mcstate" class="section level1">
<h1 class="hasAnchor">
<a href="#inferring-parameters-with-mcstate" class="anchor"></a>Inferring parameters with mcstate</h1>
<p>Typically these models will be used in conjunction with observed data to infer the highest posterior density values for model parameters, most likely trajectories up to the present (nowcast), and make forecasts using these parameters. The <code>mcstate</code> package implements particle filter and <a href="https://dx.doi.org/10.1016/j.epidem.2019.100363">pMCMC</a> methods to make all of this this possible from <code>dust</code> models.</p>
<p>A comparison function is needed to define a likelihood, i.e. the probability of observing this trajectory, given the data. This is combined with a prior to generate a posterior distribution for each parameter, which in the SIR model gives the distribution of likely values for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span>.</p>
<p>This is straightforward for a deterministic model, but for a stochastic model over a long time-series, trajectories can quickly become inconsistent with the data, and the massive space of potential outcomes makes downstream sampling highly inefficient. <code>mcstate</code> therefore implements a particle filter, also known as sequential Monte Carlo (SMC), which runs multiple trajectories, and at each stage where data is available resamples them in proportion to their likelihood, keeping only those trajectories close to the data, and with likelihoods that are plausibly important parts of the posterior. Importantly, this technique produces an unbiased estimate of the likelihood for a given set of parameters.</p>
<p>The anatomy of an mcstate particle filter, as noted above, consists of three main components:</p>
<ul>
<li>A set of observations to fit the model to, generated using <code><a href="../reference/particle_filter_data.html">mcstate::particle_filter_data()</a></code>.</li>
<li>A model to fit, which must be a dust generator, either <code><a href="https://rdrr.io/pkg/dust/man/dust.html">dust::dust()</a></code> or <code><a href="https://rdrr.io/pkg/odin.dust/man/odin_dust.html">odin.dust::odin_dust()</a></code>.</li>
<li>A comparison function, which is an R function which calculates the likelihood of the state given the data at one time point.</li>
</ul>
<div id="model-data" class="section level2">
<h2 class="hasAnchor">
<a href="#model-data" class="anchor"></a>Model data</h2>
<p>To demonstrate this, we will attempt to infer the parameters <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> using daily case counts. In reality these counts would be measured, but here we have generated them from a single run of the model with <code>seed = 2L</code>, and added some constant noise proportional to the epidemic size:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">incidence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"sir_incidence.csv"</span>, package <span class="op">=</span> <span class="st">"mcstate"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This can then be processed with <code><a href="../reference/particle_filter_data.html">mcstate::particle_filter_data()</a></code> as follows, taking four update steps between every observation so that <code>rate = 4</code>. Generally increasing the rate will improve resolution, especially if rates of change between partitions are high, though at the expense of extra computation time. We also define a time interval between each update <span class="math inline">\(dt = \frac{1}{\mathrm(rate)}\)</span>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.25</span>
<span class="va">sir_data</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/particle_filter_data.html">particle_filter_data</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">incidence</span>,
                                          time <span class="op">=</span> <span class="st">"day"</span>,
                                          rate <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">dt</span><span class="op">)</span>
<span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/paged_table.html">paged_table</a></span><span class="op">(</span><span class="va">sir_data</span><span class="op">)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["day_start"],"name":[1],"type":["int"],"align":["right"]},{"label":["day_end"],"name":[2],"type":["int"],"align":["right"]},{"label":["step_start"],"name":[3],"type":["int"],"align":["right"]},{"label":["step_end"],"name":[4],"type":["int"],"align":["right"]},{"label":["cases"],"name":[5],"type":["int"],"align":["right"]}],"data":[{"1":"0","2":"1","3":"0","4":"4","5":"3"},{"1":"1","2":"2","3":"4","4":"8","5":"2"},{"1":"2","2":"3","3":"8","4":"12","5":"2"},{"1":"3","2":"4","3":"12","4":"16","5":"2"},{"1":"4","2":"5","3":"16","4":"20","5":"1"},{"1":"5","2":"6","3":"20","4":"24","5":"3"},{"1":"6","2":"7","3":"24","4":"28","5":"2"},{"1":"7","2":"8","3":"28","4":"32","5":"5"},{"1":"8","2":"9","3":"32","4":"36","5":"5"},{"1":"9","2":"10","3":"36","4":"40","5":"6"},{"1":"10","2":"11","3":"40","4":"44","5":"9"},{"1":"11","2":"12","3":"44","4":"48","5":"3"},{"1":"12","2":"13","3":"48","4":"52","5":"5"},{"1":"13","2":"14","3":"52","4":"56","5":"7"},{"1":"14","2":"15","3":"56","4":"60","5":"9"},{"1":"15","2":"16","3":"60","4":"64","5":"12"},{"1":"16","2":"17","3":"64","4":"68","5":"13"},{"1":"17","2":"18","3":"68","4":"72","5":"13"},{"1":"18","2":"19","3":"72","4":"76","5":"17"},{"1":"19","2":"20","3":"76","4":"80","5":"16"},{"1":"20","2":"21","3":"80","4":"84","5":"14"},{"1":"21","2":"22","3":"84","4":"88","5":"24"},{"1":"22","2":"23","3":"88","4":"92","5":"16"},{"1":"23","2":"24","3":"92","4":"96","5":"16"},{"1":"24","2":"25","3":"96","4":"100","5":"21"},{"1":"25","2":"26","3":"100","4":"104","5":"18"},{"1":"26","2":"27","3":"104","4":"108","5":"17"},{"1":"27","2":"28","3":"108","4":"112","5":"14"},{"1":"28","2":"29","3":"112","4":"116","5":"15"},{"1":"29","2":"30","3":"116","4":"120","5":"18"},{"1":"30","2":"31","3":"120","4":"124","5":"14"},{"1":"31","2":"32","3":"124","4":"128","5":"13"},{"1":"32","2":"33","3":"128","4":"132","5":"17"},{"1":"33","2":"34","3":"132","4":"136","5":"9"},{"1":"34","2":"35","3":"136","4":"140","5":"21"},{"1":"35","2":"36","3":"140","4":"144","5":"15"},{"1":"36","2":"37","3":"144","4":"148","5":"20"},{"1":"37","2":"38","3":"148","4":"152","5":"19"},{"1":"38","2":"39","3":"152","4":"156","5":"18"},{"1":"39","2":"40","3":"156","4":"160","5":"20"},{"1":"40","2":"41","3":"160","4":"164","5":"21"},{"1":"41","2":"42","3":"164","4":"168","5":"25"},{"1":"42","2":"43","3":"168","4":"172","5":"14"},{"1":"43","2":"44","3":"172","4":"176","5":"7"},{"1":"44","2":"45","3":"176","4":"180","5":"13"},{"1":"45","2":"46","3":"180","4":"184","5":"9"},{"1":"46","2":"47","3":"184","4":"188","5":"18"},{"1":"47","2":"48","3":"188","4":"192","5":"12"},{"1":"48","2":"49","3":"192","4":"196","5":"10"},{"1":"49","2":"50","3":"196","4":"200","5":"16"},{"1":"50","2":"51","3":"200","4":"204","5":"6"},{"1":"51","2":"52","3":"204","4":"208","5":"10"},{"1":"52","2":"53","3":"208","4":"212","5":"4"},{"1":"53","2":"54","3":"212","4":"216","5":"15"},{"1":"54","2":"55","3":"216","4":"220","5":"3"},{"1":"55","2":"56","3":"220","4":"224","5":"4"},{"1":"56","2":"57","3":"224","4":"228","5":"8"},{"1":"57","2":"58","3":"228","4":"232","5":"8"},{"1":"58","2":"59","3":"232","4":"236","5":"2"},{"1":"59","2":"60","3":"236","4":"240","5":"2"},{"1":"60","2":"61","3":"240","4":"244","5":"5"},{"1":"61","2":"62","3":"244","4":"248","5":"5"},{"1":"62","2":"63","3":"248","4":"252","5":"4"},{"1":"63","2":"64","3":"252","4":"256","5":"3"},{"1":"64","2":"65","3":"256","4":"260","5":"2"},{"1":"65","2":"66","3":"260","4":"264","5":"5"},{"1":"66","2":"67","3":"264","4":"268","5":"6"},{"1":"67","2":"68","3":"268","4":"272","5":"0"},{"1":"68","2":"69","3":"272","4":"276","5":"3"},{"1":"69","2":"70","3":"276","4":"280","5":"3"},{"1":"70","2":"71","3":"280","4":"284","5":"4"},{"1":"71","2":"72","3":"284","4":"288","5":"1"},{"1":"72","2":"73","3":"288","4":"292","5":"1"},{"1":"73","2":"74","3":"292","4":"296","5":"0"},{"1":"74","2":"75","3":"296","4":"300","5":"3"},{"1":"75","2":"76","3":"300","4":"304","5":"3"},{"1":"76","2":"77","3":"304","4":"308","5":"4"},{"1":"77","2":"78","3":"308","4":"312","5":"1"},{"1":"78","2":"79","3":"312","4":"316","5":"3"},{"1":"79","2":"80","3":"316","4":"320","5":"1"},{"1":"80","2":"81","3":"320","4":"324","5":"0"},{"1":"81","2":"82","3":"324","4":"328","5":"0"},{"1":"82","2":"83","3":"328","4":"332","5":"3"},{"1":"83","2":"84","3":"332","4":"336","5":"3"},{"1":"84","2":"85","3":"336","4":"340","5":"1"},{"1":"85","2":"86","3":"340","4":"344","5":"0"},{"1":"86","2":"87","3":"344","4":"348","5":"0"},{"1":"87","2":"88","3":"348","4":"352","5":"3"},{"1":"88","2":"89","3":"352","4":"356","5":"1"},{"1":"89","2":"90","3":"356","4":"360","5":"3"},{"1":"90","2":"91","3":"360","4":"364","5":"7"},{"1":"91","2":"92","3":"364","4":"368","5":"5"},{"1":"92","2":"93","3":"368","4":"372","5":"0"},{"1":"93","2":"94","3":"372","4":"376","5":"1"},{"1":"94","2":"95","3":"376","4":"380","5":"0"},{"1":"95","2":"96","3":"380","4":"384","5":"4"},{"1":"96","2":"97","3":"384","4":"388","5":"1"},{"1":"97","2":"98","3":"388","4":"392","5":"0"},{"1":"98","2":"99","3":"392","4":"396","5":"5"},{"1":"99","2":"100","3":"396","4":"400","5":"1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">$</span><span class="va">day</span>, <span class="va">incidence</span><span class="op">$</span><span class="va">cases</span>,
     type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"New cases"</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>More complex models may have additional data streams added as further columns (e.g. deaths, hospital admissions). This will be fed as observed data to the compare function, which will combine and compute the evidence for the current model state.</p>
</div>
<div id="defining-the-comparison-function" class="section level2">
<h2 class="hasAnchor">
<a href="#defining-the-comparison-function" class="anchor"></a>Defining the comparison function</h2>
<p>The comparison function will typically be a likelihood, the probability of the simulation run given the data. This can be any function in R which takes the current simulated <code>state</code>, a <code>data</code> row for the current time point and a list of any parameters <code>pars</code> the function needs.</p>
<p>For this model the daily number of cases is calculated within update function and returned as the 5th state element. In this comparison function, the number of cases within each time interval is modelled as being Poisson distributed. A small amount of noise is added to prevent zero expectations.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">case_compare</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">observed</span>, <span class="va">pars</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">exp_noise</span> <span class="op">&lt;-</span> <span class="fl">1e6</span>

  <span class="va">incidence_modelled</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">5</span>, , drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>
  <span class="va">incidence_observed</span> <span class="op">&lt;-</span> <span class="va">observed</span><span class="op">$</span><span class="va">cases</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">incidence_modelled</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">incidence_modelled</span><span class="op">)</span>, rate <span class="op">=</span> <span class="va">exp_noise</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">dpois</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">incidence_observed</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We can use the <code>info()</code> method on a dust model to inspect what order the state variables will come in:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen_sir</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>, step <span class="op">=</span> <span class="fl">0</span>, n_particles <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; $vars</span>
<span class="co">#&gt; [1] "S"           "I"           "R"           "cases_cumul" "cases_inc"  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $pars</span>
<span class="co">#&gt; $pars$beta</span>
<span class="co">#&gt; [1] 0.2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $pars$gamma</span>
<span class="co">#&gt; [1] 0.1</span></code></pre></div>
<p>The SIR example actually outputs incidence directly as part of the state, so the comparison function can be written without needing to recalculate this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">incidence_compare</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">prev_state</span>, <span class="va">observed</span>, <span class="va">pars</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">exp_noise</span> <span class="op">&lt;-</span> <span class="fl">1e6</span>

  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">4</span>, , drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">incidence_modelled</span><span class="op">)</span>, rate <span class="op">=</span> <span class="va">exp_noise</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">dpois</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">observed</span><span class="op">$</span><span class="va">cases</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Just some of the state can be extracted for the comparison function, which is demonstrated below.</p>
</div>
<div id="inferring-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#inferring-parameters" class="anchor"></a>Inferring parameters</h2>
<p>Using these pieces, we can set up a particle filter as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_particles</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va"><a href="../reference/particle_filter.html">particle_filter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sir_data</span>,
                                       model <span class="op">=</span> <span class="va">gen_sir</span>,
                                       n_particles <span class="op">=</span> <span class="va">n_particles</span>,
                                       compare <span class="op">=</span> <span class="va">case_compare</span>,
                                       seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></code></pre></div>
<p>We can now run the particle filter forward, which will run and resample 100 trajectories, and return the final likelihood. It is important to set the correct time-step <code>dt</code> here, as we are using 0.25, rather than the default value of 1 defined in the odin model. We will also save the history, which allows us to plot the particle trajectories, as well as use the likelihood:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>save_history <span class="op">=</span> <span class="cn">TRUE</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] -245.6147</span></code></pre></div>
<p>If we plot these along with the data, we can see compared to above that only trajectories consistent with the data are kept, and the variance between particles has been reduced compared to the simulations shown in the <code>odin.dust</code> vignette:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_particle_filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">history</span>, <span class="va">true_history</span>, <span class="va">times</span>, <span class="va">obs_end</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">obs_end</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">obs_end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.1</span>, <span class="fl">5.1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="st">"#8c8cd9"</span>, I <span class="op">=</span> <span class="st">"#cc0044"</span>, R <span class="op">=</span> <span class="st">"#999966"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">times</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">history</span><span class="op">[</span><span class="fl">1</span>, , <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>,
          xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Number of individuals"</span>,
          col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"S"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">times</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">history</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"I"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">times</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">history</span><span class="op">[</span><span class="fl">3</span>, , <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"R"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matpoints</a></span><span class="op">(</span><span class="va">times</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">obs_end</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">true_history</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, , <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>,
            col <span class="op">=</span> <span class="va">cols</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"left"</span>, lwd <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">cols</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">true_history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"sir_true_history.rds"</span><span class="op">)</span>
<span class="fu">plot_particle_filter</span><span class="op">(</span><span class="va">filter</span><span class="op">$</span><span class="fu">history</span><span class="op">(</span><span class="op">)</span>, <span class="va">true_history</span>, <span class="va">incidence</span><span class="op">$</span><span class="va">day</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>Doing the same with a <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> which are further from the truth yields a lower likelihood:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>save_history <span class="op">=</span> <span class="cn">TRUE</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">dt</span>, beta <span class="op">=</span> <span class="fl">0.4</span>, gamma <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] -255.8066</span>
<span class="fu">plot_particle_filter</span><span class="op">(</span><span class="va">filter</span><span class="op">$</span><span class="fu">history</span><span class="op">(</span><span class="op">)</span>, <span class="va">true_history</span>, <span class="va">incidence</span><span class="op">$</span><span class="va">day</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>You can use the <code>run()</code> function of the particle filter directly, but for parameter inference, or forecasting after parameter inference, you should usually use the functions below to infer parameters.</p>
<div id="using-mcmc-to-infer-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#using-mcmc-to-infer-parameters" class="anchor"></a>Using MCMC to infer parameters</h3>
<p>Using this, we can do a MCMC using the Metropolis-Hastings algorithm to infer the values of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> from daily case counts. Let’s first describe the parameters we wish to infer, giving a minimum, maximum. For <span class="math inline">\(\gamma\)</span> we will also apply a gamma prior with shape 1 and rate 0.2: <span class="math inline">\(\Gamma(1, 0.2)\)</span>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_parameter.html">pmcmc_parameter</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="fl">0.2</span>, min <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_parameter.html">pmcmc_parameter</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="fl">0.1</span>, min <span class="op">=</span> <span class="fl">0</span>,
                         prior <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span>
                           <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="va">p</span>, shape <span class="op">=</span> <span class="fl">1</span>, scale <span class="op">=</span> <span class="fl">0.2</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                         <span class="op">)</span>

<span class="va">proposal_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.01</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">mcmc_pars</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va"><a href="../reference/pmcmc_parameters.html">pmcmc_parameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, gamma <span class="op">=</span> <span class="va">gamma</span><span class="op">)</span>, <span class="va">proposal_matrix</span><span class="op">)</span></code></pre></div>
<p>The proposals for each MCMC step are also set here. Proposals are drawn from a multi-variate normal distribution, with the variance-covariance matrix set here. In this case we have simply set <span class="math inline">\(\beta_{n+1} \sim N(\beta_{n}, 0.01)\)</span> and <span class="math inline">\(\gamma_{n+1} \sim N(\gamma_{n}, 0.01)\)</span> so there is no covariance. We show how to improve this below.</p>
<p>The sampler can now be run using these parameters, and the particle filter defined above. Taking 500 steps on a single chains:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_control.html">pmcmc_control</a></span><span class="op">(</span>
    <span class="fl">500</span>,
    save_state <span class="op">=</span> <span class="cn">TRUE</span>,
    save_trajectories <span class="op">=</span> <span class="cn">TRUE</span>,
    progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">pmcmc_run</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc.html">pmcmc</a></span><span class="op">(</span><span class="va">mcmc_pars</span>, <span class="va">filter</span>, control <span class="op">=</span> <span class="va">control</span><span class="op">)</span>
<span class="co">#&gt; Running chain 1 / 1</span>
<span class="co">#&gt; Finished 500 steps in 12 secs</span>
<span class="fu">plot_particle_filter</span><span class="op">(</span><span class="va">pmcmc_run</span><span class="op">$</span><span class="va">trajectories</span><span class="op">$</span><span class="va">state</span>, <span class="va">true_history</span>, <span class="va">incidence</span><span class="op">$</span><span class="va">day</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/pmcmc_combined-1.png" width="672"></p>
<p>We also provide some basic tools for dealing with this output, before running prediction (see below). We can remove burn-in and thin the four chains as follows:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">processed_chains</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_thin.html">pmcmc_thin</a></span><span class="op">(</span><span class="va">pmcmc_run</span>, burnin <span class="op">=</span> <span class="fl">200</span>, thin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">parameter_mean_hpd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">processed_chains</span><span class="op">$</span><span class="va">pars</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
<span class="va">parameter_mean_hpd</span>
<span class="co">#&gt;      beta     gamma </span>
<span class="co">#&gt; 0.2075909 0.1079655</span></code></pre></div>
<p>The resulting objects can also be analysed in a typical MCMC analysis package such as <a href="https://cran.r-project.org/web/packages/coda/index.html"><code>coda</code></a>. We will need to combine the two parts of the object which contain the probabilities and parameter values across the iterations:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc1</span> <span class="op">&lt;-</span> <span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pmcmc_run</span><span class="op">$</span><span class="va">probabilities</span>, <span class="va">pmcmc_run</span><span class="op">$</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mcmc1</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Iterations = 1:501</span>
<span class="co">#&gt; Thinning interval = 1 </span>
<span class="co">#&gt; Number of chains = 1 </span>
<span class="co">#&gt; Sample size per chain = 501 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 1. Empirical mean and standard deviation for each variable,</span>
<span class="co">#&gt;    plus standard error of the mean:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                     Mean      SD Naive SE Time-series SE</span>
<span class="co">#&gt; log_prior         0.9659 0.21679 0.009686        0.11592</span>
<span class="co">#&gt; log_likelihood -246.3770 2.08211 0.093022        1.06812</span>
<span class="co">#&gt; log_posterior  -245.4111 2.23647 0.099918        1.20234</span>
<span class="co">#&gt; beta              0.2375 0.06012 0.002686        0.02625</span>
<span class="co">#&gt; gamma             0.1287 0.04336 0.001937        0.02318</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 2. Quantiles for each variable:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                      2.5%        25%       50%       75%     97.5%</span>
<span class="co">#&gt; log_prior         0.58278    0.93933    1.0216    1.1719    1.2246</span>
<span class="co">#&gt; log_likelihood -249.46058 -248.34494 -245.4654 -245.0120 -243.8495</span>
<span class="co">#&gt; log_posterior  -248.87780 -247.40561 -244.5128 -243.8401 -242.8632</span>
<span class="co">#&gt; beta              0.16931    0.19214    0.2206    0.2657    0.3475</span>
<span class="co">#&gt; gamma             0.07697    0.08751    0.1176    0.1340    0.2053</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mcmc1</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/coda_plots-1.png" width="1344"><img src="sir_models_files/figure-html/coda_plots-2.png" width="1344"></p>
</div>
</div>
<div id="tuning-the-pmcmc" class="section level2">
<h2 class="hasAnchor">
<a href="#tuning-the-pmcmc" class="anchor"></a>Tuning the pMCMC</h2>
<p>The MCMC above is not particularly efficient in terms of effective sample size per iteration:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/effectiveSize.html">effectiveSize</a></span><span class="op">(</span><span class="va">mcmc1</span><span class="op">)</span>
<span class="co">#&gt;      log_prior log_likelihood  log_posterior           beta          gamma </span>
<span class="co">#&gt;       3.497715       3.799848       3.459959       5.245946       3.497715</span>
<span class="fl">1</span> <span class="op">-</span> <span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/rejectionRate.html">rejectionRate</a></span><span class="op">(</span><span class="va">mcmc1</span><span class="op">)</span>
<span class="co">#&gt;      log_prior log_likelihood  log_posterior           beta          gamma </span>
<span class="co">#&gt;          0.036          0.036          0.036          0.036          0.036</span></code></pre></div>
<p>Clearly the acceptance rate is too low. Generally a target of 0.5, reducing to 0.234 as the number of parameters increases, <a href="https://dx.doi.org/10.1016/j.spa.2007.12.005">is thought to be optimal</a>. The proposal distribution needs to be modified, in this case reducing the variance of the jump sizes. One option to automate this process is to run a chain for a bit, as above, then use the covariance of the state as the proposal matrix:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">proposal_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">pmcmc_run</span><span class="op">$</span><span class="va">pars</span><span class="op">)</span>
<span class="va">mcmc_pars</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va"><a href="../reference/pmcmc_parameters.html">pmcmc_parameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, gamma <span class="op">=</span> <span class="va">gamma</span><span class="op">)</span>,
  <span class="va">proposal_matrix</span><span class="op">)</span>
<span class="va">proposal_matrix</span>
<span class="co">#&gt;              beta       gamma</span>
<span class="co">#&gt; beta  0.003614065 0.002514306</span>
<span class="co">#&gt; gamma 0.002514306 0.001879942</span></code></pre></div>
<p>Let’s now run four independent chains with these proposals:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc_control.html">pmcmc_control</a></span><span class="op">(</span>
    <span class="fl">500</span>,
    save_state <span class="op">=</span> <span class="cn">TRUE</span>,
    save_trajectories <span class="op">=</span> <span class="cn">TRUE</span>,
    progress <span class="op">=</span> <span class="cn">TRUE</span>,
    n_chains <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="va">pmcmc_tuned_run</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/pmcmc.html">pmcmc</a></span><span class="op">(</span><span class="va">mcmc_pars</span>, <span class="va">filter</span>, control <span class="op">=</span> <span class="va">control</span><span class="op">)</span>
<span class="co">#&gt; Running chain 1 / 4</span>
<span class="co">#&gt; Finished 500 steps in 13 secs</span>
<span class="co">#&gt; Running chain 2 / 4</span>
<span class="co">#&gt; Finished 500 steps in 12 secs</span>
<span class="co">#&gt; Running chain 3 / 4</span>
<span class="co">#&gt; Finished 500 steps in 12 secs</span>
<span class="co">#&gt; Running chain 4 / 4</span>
<span class="co">#&gt; Finished 500 steps in 12 secs</span>

<span class="va">mcmc2</span> <span class="op">&lt;-</span> <span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>
  <span class="va">pmcmc_tuned_run</span><span class="op">$</span><span class="va">probabilities</span>, <span class="va">pmcmc_tuned_run</span><span class="op">$</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mcmc2</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Iterations = 1:2004</span>
<span class="co">#&gt; Thinning interval = 1 </span>
<span class="co">#&gt; Number of chains = 1 </span>
<span class="co">#&gt; Sample size per chain = 2004 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 1. Empirical mean and standard deviation for each variable,</span>
<span class="co">#&gt;    plus standard error of the mean:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                     Mean      SD  Naive SE Time-series SE</span>
<span class="co">#&gt; log_prior         1.0473 0.09663 0.0021585       0.007336</span>
<span class="co">#&gt; log_likelihood -244.4298 1.37651 0.0307490       0.177264</span>
<span class="co">#&gt; log_posterior  -243.3825 1.40470 0.0313788       0.170320</span>
<span class="co">#&gt; beta              0.2106 0.03043 0.0006798       0.002808</span>
<span class="co">#&gt; gamma             0.1124 0.01933 0.0004317       0.001467</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 2. Quantiles for each variable:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                      2.5%        25%       50%       75%     97.5%</span>
<span class="co">#&gt; log_prior         0.84320    0.99097    1.0553    1.1258    1.2102</span>
<span class="co">#&gt; log_likelihood -247.24889 -245.30548 -244.1944 -243.6049 -242.1973</span>
<span class="co">#&gt; log_posterior  -246.28369 -244.25698 -243.1398 -242.4791 -241.0614</span>
<span class="co">#&gt; beta              0.16356    0.18771    0.2101    0.2313    0.2746</span>
<span class="co">#&gt; gamma             0.07985    0.09672    0.1108    0.1237    0.1532</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mcmc2</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/unnamed-chunk-16-1.png" width="1344"><img src="sir_models_files/figure-html/unnamed-chunk-16-2.png" width="1344"></p>
<p>Looking again at the effective sample size and rejection rate, these chains were a lot more efficient, and have a much better effective sample size thanks for the four chains:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/effectiveSize.html">effectiveSize</a></span><span class="op">(</span><span class="va">mcmc2</span><span class="op">)</span>
<span class="co">#&gt;      log_prior log_likelihood  log_posterior           beta          gamma </span>
<span class="co">#&gt;      173.49301       60.30022       68.02052      117.48534      173.49301</span>
<span class="fl">1</span> <span class="op">-</span> <span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/rejectionRate.html">rejectionRate</a></span><span class="op">(</span><span class="va">mcmc2</span><span class="op">)</span>
<span class="co">#&gt;      log_prior log_likelihood  log_posterior           beta          gamma </span>
<span class="co">#&gt;      0.1667499      0.1667499      0.1667499      0.1667499      0.1667499</span></code></pre></div>
</div>
<div id="running-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#running-predictions" class="anchor"></a>Running predictions</h2>
<p>Going back to the simple SIR model above, we can easily continue running the fitted model forward in time using the posterior estimated by <code><a href="../reference/pmcmc.html">pmcmc()</a></code> to create a forecast past the end of the data, sampling 10 particles:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">processed_chains</span>,
                    steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">400</span>, <span class="fl">800</span>, <span class="fl">4</span><span class="op">)</span>,
                    prepend_trajectories <span class="op">=</span> <span class="cn">TRUE</span>,
                    seed <span class="op">=</span> <span class="va">processed_chains</span><span class="op">$</span><span class="va">predict</span><span class="op">$</span><span class="va">seed</span><span class="op">)</span>

<span class="va">mini_forecast</span> <span class="op">&lt;-</span> <span class="va">forecast</span><span class="op">$</span><span class="va">state</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,<span class="op">]</span>

<span class="fu">plot_particle_filter</span><span class="op">(</span><span class="va">mini_forecast</span>,
                     <span class="va">true_history</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>,
                     obs_end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">$</span><span class="va">day</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
<p>Up to <span class="math inline">\(t = 100\)</span> is the nowcast, from <span class="math inline">\(t = 100\)</span> to <span class="math inline">\(t = 200\)</span> is the forecast.</p>
</div>
<div id="fitting-to-multiple-datastreams" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-to-multiple-datastreams" class="anchor"></a>Fitting to multiple datastreams</h2>
<p>The set up of the particle filter and observation function makes it easy to fit to multiple datastreams within a Bayesian framework. Let us model a disease where a proportion of infected cases <span class="math inline">\(p_{\mathrm{death}} = 0.05\)</span> die rather than recover by adding the following lines to the odin code:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Definition of the time-step and output as "time"</span>
<span class="va">steps_per_day</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">steps_per_day</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">step</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">dt</span>

<span class="co">## Core equations for transitions between compartments:</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">-</span> <span class="va">n_SI</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span> <span class="op">+</span> <span class="va">n_SI</span> <span class="op">-</span> <span class="va">n_IR</span> <span class="op">-</span> <span class="va">n_ID</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="va">n_IR</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op">+</span> <span class="va">n_ID</span>

<span class="co">## Individual probabilities of transition:</span>
<span class="va">p_SI</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span> <span class="co"># S to I</span>
<span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span><span class="op">)</span> <span class="co"># I to R</span>

<span class="co">## Draws from binomial distributions for numbers changing between</span>
<span class="co">## compartments, dealing competing hazards for I -&gt; R and I -&gt; D</span>
<span class="va">n_Ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">I</span>, <span class="va">p_IR</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span>
<span class="va">n_IR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_Ix</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">p_death</span><span class="op">)</span>
<span class="va">n_ID</span> <span class="op">&lt;-</span> <span class="va">n_Ix</span> <span class="op">-</span> <span class="va">n_IR</span>
<span class="va">n_SI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">p_SI</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span>

<span class="co">## Total population size</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">+</span> <span class="va">I</span> <span class="op">+</span> <span class="va">R</span>

<span class="co">## Initial states:</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S_ini</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I_ini</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">D</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="co">## Convert some cumulative values into incidence:</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">S_inc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">D_inc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">S_inc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">step</span> <span class="op">%%</span> <span class="va">steps_per_day</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="va">n_SI</span> <span class="kw">else</span> <span class="va">S_inc</span> <span class="op">+</span> <span class="va">n_SI</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">D_inc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">step</span> <span class="op">%%</span> <span class="va">steps_per_day</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="va">n_ID</span> <span class="kw">else</span> <span class="va">D_inc</span> <span class="op">+</span> <span class="va">n_ID</span>

<span class="co">## User defined parameters - default in parentheses:</span>
<span class="va">S_ini</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>
<span class="va">I_ini</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span>
<span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>
<span class="va">p_death</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.05</span><span class="op">)</span></code></pre></div>
<p>Creating a model from this code:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen_death</span> <span class="op">&lt;-</span> <span class="fu">odin.dust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/odin.dust/man/odin_dust.html">odin_dust</a></span><span class="op">(</span><span class="st">"deaths.R"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Loading required namespace: pkgbuild</span></code></pre></div>
<p>We can simulate some data to fit to, as before. We have also made the case data patchy, so it is missing on some days:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.25</span>
<span class="va">death_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"death_data.csv"</span>, header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span>
<span class="va">true_history_deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"deaths_true_history.rds"</span><span class="op">)</span>

<span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu"><a href="../reference/particle_filter_data.html">particle_filter_data</a></span><span class="op">(</span>
  <span class="va">death_data</span>,
  time <span class="op">=</span> <span class="st">"day"</span>,
  rate <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">dt</span>
<span class="op">)</span>
<span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/paged_table.html">paged_table</a></span><span class="op">(</span><span class="va">combined_data</span><span class="op">)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["day_start"],"name":[1],"type":["int"],"align":["right"]},{"label":["day_end"],"name":[2],"type":["int"],"align":["right"]},{"label":["step_start"],"name":[3],"type":["int"],"align":["right"]},{"label":["step_end"],"name":[4],"type":["int"],"align":["right"]},{"label":["cases"],"name":[5],"type":["int"],"align":["right"]},{"label":["deaths"],"name":[6],"type":["int"],"align":["right"]}],"data":[{"1":"0","2":"1","3":"0","4":"4","5":"1","6":"0"},{"1":"1","2":"2","3":"4","4":"8","5":"0","6":"0"},{"1":"2","2":"3","3":"8","4":"12","5":"0","6":"0"},{"1":"3","2":"4","3":"12","4":"16","5":"1","6":"0"},{"1":"4","2":"5","3":"16","4":"20","5":"1","6":"0"},{"1":"5","2":"6","3":"20","4":"24","5":"1","6":"0"},{"1":"6","2":"7","3":"24","4":"28","5":"0","6":"0"},{"1":"7","2":"8","3":"28","4":"32","5":"2","6":"0"},{"1":"8","2":"9","3":"32","4":"36","5":"1","6":"0"},{"1":"9","2":"10","3":"36","4":"40","5":"1","6":"0"},{"1":"10","2":"11","3":"40","4":"44","5":"3","6":"0"},{"1":"11","2":"12","3":"44","4":"48","5":"2","6":"1"},{"1":"12","2":"13","3":"48","4":"52","5":"0","6":"0"},{"1":"13","2":"14","3":"52","4":"56","5":"NA","6":"0"},{"1":"14","2":"15","3":"56","4":"60","5":"0","6":"0"},{"1":"15","2":"16","3":"60","4":"64","5":"5","6":"0"},{"1":"16","2":"17","3":"64","4":"68","5":"4","6":"0"},{"1":"17","2":"18","3":"68","4":"72","5":"4","6":"0"},{"1":"18","2":"19","3":"72","4":"76","5":"2","6":"0"},{"1":"19","2":"20","3":"76","4":"80","5":"4","6":"0"},{"1":"20","2":"21","3":"80","4":"84","5":"NA","6":"0"},{"1":"21","2":"22","3":"84","4":"88","5":"NA","6":"0"},{"1":"22","2":"23","3":"88","4":"92","5":"3","6":"0"},{"1":"23","2":"24","3":"92","4":"96","5":"2","6":"0"},{"1":"24","2":"25","3":"96","4":"100","5":"2","6":"0"},{"1":"25","2":"26","3":"100","4":"104","5":"6","6":"1"},{"1":"26","2":"27","3":"104","4":"108","5":"4","6":"0"},{"1":"27","2":"28","3":"108","4":"112","5":"11","6":"0"},{"1":"28","2":"29","3":"112","4":"116","5":"6","6":"1"},{"1":"29","2":"30","3":"116","4":"120","5":"6","6":"0"},{"1":"30","2":"31","3":"120","4":"124","5":"8","6":"0"},{"1":"31","2":"32","3":"124","4":"128","5":"11","6":"1"},{"1":"32","2":"33","3":"128","4":"132","5":"6","6":"0"},{"1":"33","2":"34","3":"132","4":"136","5":"6","6":"1"},{"1":"34","2":"35","3":"136","4":"140","5":"10","6":"0"},{"1":"35","2":"36","3":"140","4":"144","5":"7","6":"2"},{"1":"36","2":"37","3":"144","4":"148","5":"4","6":"0"},{"1":"37","2":"38","3":"148","4":"152","5":"8","6":"0"},{"1":"38","2":"39","3":"152","4":"156","5":"5","6":"1"},{"1":"39","2":"40","3":"156","4":"160","5":"14","6":"0"},{"1":"40","2":"41","3":"160","4":"164","5":"17","6":"0"},{"1":"41","2":"42","3":"164","4":"168","5":"19","6":"0"},{"1":"42","2":"43","3":"168","4":"172","5":"15","6":"0"},{"1":"43","2":"44","3":"172","4":"176","5":"13","6":"0"},{"1":"44","2":"45","3":"176","4":"180","5":"20","6":"1"},{"1":"45","2":"46","3":"180","4":"184","5":"23","6":"1"},{"1":"46","2":"47","3":"184","4":"188","5":"17","6":"0"},{"1":"47","2":"48","3":"188","4":"192","5":"18","6":"0"},{"1":"48","2":"49","3":"192","4":"196","5":"8","6":"1"},{"1":"49","2":"50","3":"196","4":"200","5":"23","6":"1"},{"1":"50","2":"51","3":"200","4":"204","5":"27","6":"0"},{"1":"51","2":"52","3":"204","4":"208","5":"20","6":"2"},{"1":"52","2":"53","3":"208","4":"212","5":"26","6":"1"},{"1":"53","2":"54","3":"212","4":"216","5":"15","6":"0"},{"1":"54","2":"55","3":"216","4":"220","5":"12","6":"3"},{"1":"55","2":"56","3":"220","4":"224","5":"11","6":"3"},{"1":"56","2":"57","3":"224","4":"228","5":"11","6":"1"},{"1":"57","2":"58","3":"228","4":"232","5":"16","6":"1"},{"1":"58","2":"59","3":"232","4":"236","5":"17","6":"0"},{"1":"59","2":"60","3":"236","4":"240","5":"14","6":"0"},{"1":"60","2":"61","3":"240","4":"244","5":"16","6":"3"},{"1":"61","2":"62","3":"244","4":"248","5":"8","6":"1"},{"1":"62","2":"63","3":"248","4":"252","5":"15","6":"0"},{"1":"63","2":"64","3":"252","4":"256","5":"19","6":"2"},{"1":"64","2":"65","3":"256","4":"260","5":"7","6":"0"},{"1":"65","2":"66","3":"260","4":"264","5":"8","6":"2"},{"1":"66","2":"67","3":"264","4":"268","5":"6","6":"1"},{"1":"67","2":"68","3":"268","4":"272","5":"13","6":"0"},{"1":"68","2":"69","3":"272","4":"276","5":"13","6":"1"},{"1":"69","2":"70","3":"276","4":"280","5":"11","6":"1"},{"1":"70","2":"71","3":"280","4":"284","5":"17","6":"1"},{"1":"71","2":"72","3":"284","4":"288","5":"12","6":"1"},{"1":"72","2":"73","3":"288","4":"292","5":"6","6":"1"},{"1":"73","2":"74","3":"292","4":"296","5":"10","6":"1"},{"1":"74","2":"75","3":"296","4":"300","5":"6","6":"1"},{"1":"75","2":"76","3":"300","4":"304","5":"8","6":"0"},{"1":"76","2":"77","3":"304","4":"308","5":"10","6":"1"},{"1":"77","2":"78","3":"308","4":"312","5":"2","6":"0"},{"1":"78","2":"79","3":"312","4":"316","5":"3","6":"0"},{"1":"79","2":"80","3":"316","4":"320","5":"4","6":"0"},{"1":"80","2":"81","3":"320","4":"324","5":"4","6":"2"},{"1":"81","2":"82","3":"324","4":"328","5":"6","6":"1"},{"1":"82","2":"83","3":"328","4":"332","5":"3","6":"0"},{"1":"83","2":"84","3":"332","4":"336","5":"7","6":"1"},{"1":"84","2":"85","3":"336","4":"340","5":"5","6":"0"},{"1":"85","2":"86","3":"340","4":"344","5":"3","6":"0"},{"1":"86","2":"87","3":"344","4":"348","5":"2","6":"0"},{"1":"87","2":"88","3":"348","4":"352","5":"2","6":"0"},{"1":"88","2":"89","3":"352","4":"356","5":"4","6":"0"},{"1":"89","2":"90","3":"356","4":"360","5":"4","6":"2"},{"1":"90","2":"91","3":"360","4":"364","5":"3","6":"0"},{"1":"91","2":"92","3":"364","4":"368","5":"2","6":"0"},{"1":"92","2":"93","3":"368","4":"372","5":"3","6":"0"},{"1":"93","2":"94","3":"372","4":"376","5":"5","6":"0"},{"1":"94","2":"95","3":"376","4":"380","5":"2","6":"0"},{"1":"95","2":"96","3":"380","4":"384","5":"NA","6":"0"},{"1":"96","2":"97","3":"384","4":"388","5":"4","6":"0"},{"1":"97","2":"98","3":"388","4":"392","5":"6","6":"0"},{"1":"98","2":"99","3":"392","4":"396","5":"3","6":"0"},{"1":"99","2":"100","3":"396","4":"400","5":"0","6":"0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>We then need to add this into our comparison function, and in doing so we will also demonstrate the use of the <code>index</code> parameter for the particle filter.</p>
<p>For models with a very large state space returning only those compartments required by the comparison function can be important for efficiency. The only model outputs needed from the comparison function are <span class="math inline">\(S\)</span> and <span class="math inline">\(D\)</span>. So, an index function to extract just this part of the state can be defined, which operates on dust generators <code>info()</code>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">index</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">info</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">info</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">S_inc</span>,
               <span class="va">info</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">D_inc</span><span class="op">)</span>,
       state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">info</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">S</span>,
                 <span class="va">info</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">I</span>,
                 <span class="va">info</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">R</span>,
                 <span class="va">info</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">D</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">death_model</span> <span class="op">&lt;-</span> <span class="va">gen_death</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>, step <span class="op">=</span> <span class="fl">0</span>, n_particles <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>
<span class="fu">index</span><span class="op">(</span><span class="va">death_model</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $run</span>
<span class="co">#&gt; [1] 6 7</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $state</span>
<span class="co">#&gt; [1] 2 3 4 5</span></code></pre></div>
<p>Which sends the comparison function the indices listed under <code>run</code>, in this case the number of susceptibles, and saves any compartments listed under <code>state</code> if the history is kept. In the <code>compare()</code> function the index of <code>state</code> now corresponds to <code>index$run</code>. The missing data must be checked for, and contribute 0 to the likelihood if found:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># log-likelihood of Poisson count</span>
<span class="va">ll_pois</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obs</span>, <span class="va">model</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">exp_noise</span> <span class="op">&lt;-</span> <span class="fl">1e6</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Creates vector of zeros in ll with same length, if no data</span>
    <span class="va">ll_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op">+</span>
      <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>, rate <span class="op">=</span> <span class="va">exp_noise</span><span class="op">)</span>
    <span class="va">ll_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">dpois</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">obs</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">ll_obs</span>
<span class="op">}</span>

<span class="co"># Sum log likelihoods from each datastream</span>
<span class="va">combined_compare</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">observed</span>, <span class="va">pars</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ll_cases</span> <span class="op">&lt;-</span> <span class="fu">ll_pois</span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">cases</span>, <span class="va">state</span><span class="op">[</span><span class="fl">1</span>, , drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span><span class="op">)</span>
  <span class="va">ll_deaths</span> <span class="op">&lt;-</span> <span class="fu">ll_pois</span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">deaths</span>, <span class="va">state</span><span class="op">[</span><span class="fl">2</span>, , drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span><span class="op">)</span>
  <span class="va">ll_cases</span> <span class="op">+</span> <span class="va">ll_deaths</span>
<span class="op">}</span></code></pre></div>
<p>This can be used to set up a particle filter as before:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_particles</span> <span class="op">&lt;-</span> <span class="fl">100L</span>
<span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va"><a href="../reference/particle_filter.html">particle_filter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>data <span class="op">=</span> <span class="va">combined_data</span>,
                                       model <span class="op">=</span> <span class="va">gen_death</span>,
                                       n_particles <span class="op">=</span> <span class="va">n_particles</span>,
                                       compare <span class="op">=</span> <span class="va">combined_compare</span>,
                                       index <span class="op">=</span> <span class="va">index</span>,
                                       seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>
<span class="va">filter</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>save_history <span class="op">=</span> <span class="cn">FALSE</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] -1434.449</span></code></pre></div>
<p>and this can be used to run the <code><a href="../reference/pmcmc.html">pmcmc()</a></code> method, as above.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rich FitzJohn, Marc Baguelin, Edward Knock, Lilith Whittles, John Lees, Raphael Sonabend.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
