<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Particle filter — particle_filter • mcstate</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Particle filter — particle_filter"><meta property="og:description" content="Create a particle_filter object for running
and interacting with a particle filter.  A higher-level
interface will be implemented later."><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcstate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/deterministic.html">Deterministic models</a>
    </li>
    <li>
      <a href="../articles/if2.html">Inference with iterated filtering</a>
    </li>
    <li>
      <a href="../articles/kalman.html">Validation of SMC using a Kalman filter</a>
    </li>
    <li>
      <a href="../articles/nested_sir_models.html">Nested SIR Models</a>
    </li>
    <li>
      <a href="../articles/parallelisation.html">Parallelisation of inference</a>
    </li>
    <li>
      <a href="../articles/restart.html">Restarting pMCMC</a>
    </li>
    <li>
      <a href="../articles/sir_models.html">SIR models with odin, dust and mcstate</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/mrc-ide/mcstate/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Particle filter</h1>
    <small class="dont-index">Source: <a href="https://github.com/mrc-ide/mcstate/blob/HEAD/R/particle_filter.R" class="external-link"><code>R/particle_filter.R</code></a></small>
    <div class="hidden name"><code>particle_filter.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Create a <code>particle_filter</code> object for running
and interacting with a particle filter.  A higher-level
interface will be implemented later.</p>
    </div>


    <div id="public-fields">
    <h2>Public fields</h2>
    <p></p><div class="r6-fields"><dl><dt><code>model</code></dt>
<dd><p>The dust model generator being simulated (cannot be
re-bound)</p></dd>


<dt><code>n_particles</code></dt>
<dd><p>Number of particles used (read only)</p></dd>


<dt><code>has_multiple_parameters</code></dt>
<dd><p>Logical, indicating if the
particle filter requires multiple parameter sets in a list
as inputs, and if it it will produce a vector of likelihoods
the same length (read only).  The parameter sets may or may
not use the same data (see <code>has_multiple_data</code>).</p></dd>


<dt><code>has_multiple_data</code></dt>
<dd><p>Logical, indicating if the particle
filter simultaneously calculates the likelihood for multiple
parameter sets (read only). If <code>TRUE</code>, <code>has_multiple_parameters</code>
will always be <code>TRUE</code>.</p></dd>


<dt><code>n_parameters</code></dt>
<dd><p>The number of parameter sets used by this
particle filter (read only).  The returned vector of likelihood
will be this length, and if <code>has_multiple_parameters</code> is <code>FALSE</code>
this will be 1.</p></dd>


<dt><code>n_data</code></dt>
<dd><p>The number of data sets used by this particle filter
(read only).  This will either be 1 or the same value as
<code>n_parameters</code>.</p></dd>


</dl><p></p></div>
    </div>
    <div id="methods">
    <h2>Methods</h2>
    
<div class="section">
<h3 id="public-methods">Public methods<a class="anchor" aria-label="anchor" href="#public-methods"></a></h3>

<ul><li><p><a href="#method-particle_filter-new"><code>particle_filter$new()</code></a></p></li>
<li><p><a href="#method-particle_filter-run"><code>particle_filter$run()</code></a></p></li>
<li><p><a href="#method-particle_filter-run_begin"><code>particle_filter$run_begin()</code></a></p></li>
<li><p><a href="#method-particle_filter-state"><code>particle_filter$state()</code></a></p></li>
<li><p><a href="#method-particle_filter-history"><code>particle_filter$history()</code></a></p></li>
<li><p><a href="#method-particle_filter-statistics"><code>particle_filter$statistics()</code></a></p></li>
<li><p><a href="#method-particle_filter-restart_state"><code>particle_filter$restart_state()</code></a></p></li>
<li><p><a href="#method-particle_filter-inputs"><code>particle_filter$inputs()</code></a></p></li>
<li><p><a href="#method-particle_filter-set_n_threads"><code>particle_filter$set_n_threads()</code></a></p></li>
</ul></div><p></p><hr><a id="method-particle_filter-new"></a><div class="section">
<h3 id="method-new-">Method <code>new()</code><a class="anchor" aria-label="anchor" href="#method-new-"></a></h3>
<p>Create the particle filter</p><div class="section">
<h4 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va"><a href="../reference/particle_filter.html">particle_filter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">model</span>,</span>
<span>  <span class="va">n_particles</span>,</span>
<span>  <span class="va">compare</span>,</span>
<span>  index <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  initial <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  constant_log_likelihood <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_threads <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_parameters <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  gpu_config <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  stochastic_schedule <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ode_control <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h4>
<p></p><div class="arguments"><dl><dt><code>data</code></dt>
<dd><p>The data set to be used for the particle filter,
created by <code><a href="particle_filter_data.html">particle_filter_data()</a></code>. This is essentially
a <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> with at least columns <code>step_start</code>
and <code>step_end</code>, along with any additional data used in the
<code>compare</code> function, and additional information about how your
steps relate to time.</p></dd>


<dt><code>model</code></dt>
<dd><p>A stochastic model to use.  Must be a
<code>dust_generator</code> object.</p></dd>


<dt><code>n_particles</code></dt>
<dd><p>The number of particles to simulate</p></dd>


<dt><code>compare</code></dt>
<dd><p>A comparison function.  Must take arguments
<code>state</code>, <code>observed</code> and <code>pars</code> as arguments (though the arguments
may have different names). <code>state</code> is the simulated model state
(a matrix with as many rows as there are state variables and as
many columns as there are particles, <code>data</code>
is a <code>list</code> of observed data corresponding to the current
time's row in the <code>data</code> object provided here in the
constructor.  <code>pars</code> is any additional parameters passed
through to the comparison function (via the <code>pars</code>
argument to <code>$run</code>). Alternatively, <code>compare</code> can be <code>NULL</code>
if your model provides a built-in compile compare function
(if <code>model$public_methods$has_compare()</code> is <code>TRUE</code>), which may
be faster.</p></dd>


<dt><code>index</code></dt>
<dd><p>An index function. This is used to compute the
"interesting" indexes of your model. It must be a function of
one argument, which will be the result of calling the
<code>$info()</code> method on your model. It should return a list
with elements <code>run</code> (indices to return at the end of each
run, passed through to your compare function) and <code>state</code>
(indices to return if saving state). These indices can overlap
but do not have to. This argument is optional but using it will
likely speed up your simulation if you have more than a few
states as it will reduce the amount of memory copied back and
forth.</p></dd>


<dt><code>initial</code></dt>
<dd><p>A function to generate initial conditions. If
given, then this function must accept 3 arguments: <code>info</code>
(the result of calling <code>$info()</code> as for <code>index</code>),
<code>n_particles</code> (the number of particles that the particle
filter is using) and <code>pars</code> (parameters passed in in the
<code>$run</code> method via the <code>pars</code> argument).  It
must return a list, which can have the elements <code>state</code>
(initial model state, passed to the particle filter - either a
vector or a matrix, and overriding the initial conditions
provided by your model) and <code>step</code> (the initial step,
overriding the first step of your data - this must occur within
your first epoch in your <code>data</code> provided to the
constructor, i.e., not less than the first element of
<code>step_start</code> and not more than <code>step_end</code>). Your function
can also return a vector or matrix of <code>state</code> and not alter
the starting step, which is equivalent to returning
<code>list(state = state, step = NULL)</code>.</p></dd>


<dt><code>constant_log_likelihood</code></dt>
<dd><p>An optional function, taking the
model parameters, that computes the constant part of the
log-likelihood value (if any).  You can use this where your
likelihood depends both on the time series (via <code>data</code>) but also
on some non-temporal data.  You should bind any non-parameter
dependencies into this closure.  This is applied at the
beginning of the filter run, so represents the initial
condition of the marginal log likelihood value propagated by
the filter.</p></dd>


<dt><code>n_threads</code></dt>
<dd><p>Number of threads to use when running the
simulation. Defaults to 1, and should not be set higher than the
number of cores available to the machine.</p></dd>


<dt><code>seed</code></dt>
<dd><p>Seed for the random number generator on initial
creation. Can be <code>NULL</code> (to initialise using R's random number
generator), a positive integer, or a raw vector - see <code><a href="https://rdrr.io/pkg/dust/man/dust.html" class="external-link">dust::dust</a></code>
and <code><a href="https://rdrr.io/pkg/dust/man/dust_rng.html" class="external-link">dust::dust_rng</a></code> for more details. Note that the random number
stream is unrelated from R's random number generator, except for
initialisation with <code>seed = NULL</code>.</p></dd>


<dt><code>n_parameters</code></dt>
<dd><p>Number of parameter sets required.  This, along
with <code>data</code>, controls the interpretation of how the particle
filter, and importantly will add an additional dimension to
most outputs (scalars become vectors, vectors become matrices etc).</p></dd>


<dt><code>gpu_config</code></dt>
<dd><p>GPU configuration, typically an integer
indicating the device to use, where the model has GPU support.
An error is thrown if the device id given is larger than those
reported to be available (note that CUDA numbers devices from 0,
so that '0' is the first device, so on). See the method <code>$gpu_info()</code>
for available device ids; this can be called before object creation
as <code>model$public_methods$gpu_info()</code>.
For additional control, provide a list with elements <code>device_id</code>
and <code>run_block_size</code>. Further options (and validation) of this
list will be added in a future version!</p></dd>


<dt><code>stochastic_schedule</code></dt>
<dd><p>Vector of times to perform stochastic updates</p></dd>


<dt><code>ode_control</code></dt>
<dd><p>Tuning control for stepper</p></dd>


</dl><p></p></div>
</div>

</div><p></p><hr><a id="method-particle_filter-run"></a><div class="section">
<h3 id="method-run-">Method <code>run()</code><a class="anchor" aria-label="anchor" href="#method-run-"></a></h3>
<p>Run the particle filter</p><div class="section">
<h4 id="usage-1">Usage<a class="anchor" aria-label="anchor" href="#usage-1"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span></span>
<span>  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  save_history <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  save_restart <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min_log_likelihood <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-1">Arguments<a class="anchor" aria-label="anchor" href="#arguments-1"></a></h4>
<p></p><div class="arguments"><dl><dt><code>pars</code></dt>
<dd><p>A list representing parameters. This will be passed as
the <code>pars</code> argument to your model, to your <code>compare</code>
function, and (if using) to your <code>initial</code> function. It must
be an R list (not vector or <code>NULL</code>) because that is what a
dust model currently requires on initialisation or <code>$reset</code> - we
may relax this later. You may want to put your observation and
initial parameters under their own keys (e.g.,
<code>pars$initial$whatever</code>), but this is up to you. Extra keys
are silently ignored by dust models.</p></dd>


<dt><code>save_history</code></dt>
<dd><p>Logical, indicating if the history of all
particles should be saved. If saving history, then it can be
queried later with the <code>$history</code> method on the object.</p></dd>


<dt><code>save_restart</code></dt>
<dd><p>An integer vector of time points to save
restart infomation for. These are in terms of your underlying time
variable (the <code>time</code> column in <code><a href="particle_filter_data.html">particle_filter_data()</a></code>) not in
terms of steps. The state will be saved after the particle
filtering operation (i.e., at the end of the step).</p></dd>


<dt><code>min_log_likelihood</code></dt>
<dd><p>Optionally, a numeric value representing the
smallest likelihood we are interested in. If given and the particle
filter drops below this number, then we terminate early and return
<code>-Inf</code>. In this case, history and final state cannot be returned
from the filter. This is primarily intended for use with
<a href="pmcmc.html">pmcmc</a> where we can avoid computing likelihoods that
will certainly be rejected. Only suitable for use where
log-likelihood increments (with the <code>compare</code> function) are always
negative. This is the case if you use a normalised discrete
distribution, but not necessarily otherwise. If using a
multi-parameter filter this can be a single number (in which case
the exit is when the sum of log-likelihoods drops below this
threshold) or a vector of numbers the same length as <code>pars</code> (in
which case exit occurs when all numbers drop below this threshold).</p></dd>


</dl><p></p></div>
</div>
<div class="section">
<h4 id="returns">Returns<a class="anchor" aria-label="anchor" href="#returns"></a></h4>
<p>A single numeric value representing the log-likelihood
(<code>-Inf</code> if the model is impossible)</p>
</div>

</div><p></p><hr><a id="method-particle_filter-run_begin"></a><div class="section">
<h3 id="method-run-begin-">Method <code>run_begin()</code><a class="anchor" aria-label="anchor" href="#method-run-begin-"></a></h3>
<p>Begin a particle filter run. This is part of the
"advanced" interface for the particle filter; typically you will
want to use <code>$run()</code> which provides a user-facing wrapper around
this function. Once created with <code>$run_begin()</code>, you should take
as many steps as needed with <code>$step()</code>.</p><div class="section">
<h4 id="usage-2">Usage<a class="anchor" aria-label="anchor" href="#usage-2"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">run_begin</span><span class="op">(</span></span>
<span>  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  save_history <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  save_restart <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min_log_likelihood <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-2">Arguments<a class="anchor" aria-label="anchor" href="#arguments-2"></a></h4>
<p></p><div class="arguments"><dl><dt><code>pars</code></dt>
<dd><p>A list representing parameters. See <code>$run()</code> for details.</p></dd>


<dt><code>save_history</code></dt>
<dd><p>Logical, indicating if the history of all
particles should be saved. See <code>$run()</code> for details.</p></dd>


<dt><code>save_restart</code></dt>
<dd><p>Times to save restart state at. See <code>$run()</code> for
details.</p></dd>


<dt><code>min_log_likelihood</code></dt>
<dd><p>Optionally, a numeric value representing the
smallest likelihood we are interested in. See <code>$run()</code> for details.</p></dd>


</dl><p></p></div>
</div>
<div class="section">
<h4 id="returns-1">Returns<a class="anchor" aria-label="anchor" href="#returns-1"></a></h4>
<p>An object of class <code>particle_filter_state</code>, with methods
<code>step</code> and <code>end</code>. This interface is still subject to change.</p>
</div>

</div><p></p><hr><a id="method-particle_filter-state"></a><div class="section">
<h3 id="method-state-">Method <code>state()</code><a class="anchor" aria-label="anchor" href="#method-state-"></a></h3>
<p>Extract the current model state, optionally filtering.
If the model has not yet been run, then this method will throw an
error. Returns a matrix with the number of rows being the number of
model states, and the number of columns being the number of
particles.</p><div class="section">
<h4 id="usage-3">Usage<a class="anchor" aria-label="anchor" href="#usage-3"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span>index_state <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-3">Arguments<a class="anchor" aria-label="anchor" href="#arguments-3"></a></h4>
<p></p><div class="arguments"><dl><dt><code>index_state</code></dt>
<dd><p>Optional vector of states to extract</p></dd>


</dl><p></p></div>
</div>

</div><p></p><hr><a id="method-particle_filter-history"></a><div class="section">
<h3 id="method-history-">Method <code><a href="https://rdrr.io/r/utils/savehistory.html" class="external-link">history()</a></code><a class="anchor" aria-label="anchor" href="#method-history-"></a></h3>
<p>Extract the particle trajectories. Requires that
the model was run with <code>save_history = TRUE</code>, which does
incur a performance cost. This method will throw an error if
the model has not run, or was run without <code>save_history = TRUE</code>. Returns a 3d array with dimensions corresponding to (1)
model state, filtered by <code>index$run</code> if provided, (2)
particle (following <code>index_particle</code> if provided), (3)
time point. If using a multi-parameter filter then returns a 4d array
with dimensions corresponding to (1) model state, (2) particle, (3)
parameter, (4) time point.</p><div class="section">
<h4 id="usage-4">Usage<a class="anchor" aria-label="anchor" href="#usage-4"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">history</span><span class="op">(</span>index_particle <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-4">Arguments<a class="anchor" aria-label="anchor" href="#arguments-4"></a></h4>
<p></p><div class="arguments"><dl><dt><code>index_particle</code></dt>
<dd><p>Optional vector of particle indices to return.
If using a multi-parameter filter then a vector will be replicated
to a matrix with number of columns equal to number of parameters,
otherwise a matrix can be supplied. If <code>NULL</code> we return all particles'
histories.</p></dd>


</dl><p></p></div>
</div>

</div><p></p><hr><a id="method-particle_filter-statistics"></a><div class="section">
<h3 id="method-statistics-">Method <code>statistics()</code><a class="anchor" aria-label="anchor" href="#method-statistics-"></a></h3>
<p>Fetch statistics about steps taken during the integration, by
calling through to the <code>$statistics()</code> method of the underlying
model. This is only available for continuous time (ODE) models,
and will error if used with discrete time models.</p><div class="section">
<h4 id="usage-5">Usage<a class="anchor" aria-label="anchor" href="#usage-5"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">statistics</span><span class="op">(</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>


</div><p></p><hr><a id="method-particle_filter-restart_state"></a><div class="section">
<h3 id="method-restart-state-">Method <code>restart_state()</code><a class="anchor" aria-label="anchor" href="#method-restart-state-"></a></h3>
<p>Return the full particle filter state at points back in time
that were saved with the <code>save_restart</code> argument to
<code>$run()</code>. If available, this will return a 3d array, with
dimensions representing (1) particle state, (2) particle index,
(3) time point. If multiple parameters are used then returns a 4d array,
with dimensions representing (1) particle state, (2) particle index,
(3) parameter set, (4) time point. This could be quite large, especially
if you are using the <code>index</code> argument to create the particle filter
and return a subset of all state generally. It is also
different to the saved trajectories returned by <code>$history()</code>
because earlier saved state is not filtered by later filtering
(in the history we return the tree of history representing the
histories of the <em>final</em> particles, here we are returning all
particles at the requested point, regardless if they appear in
the set of particles that make it to the end of the
simulation).</p><div class="section">
<h4 id="usage-6">Usage<a class="anchor" aria-label="anchor" href="#usage-6"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">restart_state</span><span class="op">(</span>index_particle <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-5">Arguments<a class="anchor" aria-label="anchor" href="#arguments-5"></a></h4>
<p></p><div class="arguments"><dl><dt><code>index_particle</code></dt>
<dd><p>Optional vector of particle indices to return.
If <code>NULL</code> we return all particles' states.</p></dd>


</dl><p></p></div>
</div>

</div><p></p><hr><a id="method-particle_filter-inputs"></a><div class="section">
<h3 id="method-inputs-">Method <code>inputs()</code><a class="anchor" aria-label="anchor" href="#method-inputs-"></a></h3>
<p>Return a list of inputs used to configure the particle
filter. These correspond directly to the argument names for the
particle filter constructor and are the same as the input
argument with the exception of <code>seed</code>, which is the state of
the rng if it has been used (this can be used as a seed to
restart the model).</p><div class="section">
<h4 id="usage-7">Usage<a class="anchor" aria-label="anchor" href="#usage-7"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">inputs</span><span class="op">(</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>


</div><p></p><hr><a id="method-particle_filter-set_n_threads"></a><div class="section">
<h3 id="method-set-n-threads-">Method <code>set_n_threads()</code><a class="anchor" aria-label="anchor" href="#method-set-n-threads-"></a></h3>
<p>Set the number of threads used by the particle filter (and dust
model) after creation. This can be used to allocate additional
(or subtract excess) computing power from a particle filter.
Returns (invisibly) the previous value.</p><div class="section">
<h4 id="usage-8">Usage<a class="anchor" aria-label="anchor" href="#usage-8"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">set_n_threads</span><span class="op">(</span><span class="va">n_threads</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-6">Arguments<a class="anchor" aria-label="anchor" href="#arguments-6"></a></h4>
<p></p><div class="arguments"><dl><dt><code>n_threads</code></dt>
<dd><p>The new number of threads to use. You may want to
wrap this argument in <code><a href="https://rdrr.io/pkg/dust/man/dust_openmp_threads.html" class="external-link">dust::dust_openmp_threads()</a></code> in order to
verify that you can actually use the number of threads
requested (based on environment variables and OpenMP support).</p></dd>


</dl><p></p></div>
</div>

</div>

    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># A basic SIR model included in the dust package</span></span></span>
<span class="r-in"><span><span class="va">gen</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dust/man/dust_example.html" class="external-link">dust_example</a></span><span class="op">(</span><span class="st">"sir"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Some data that we will fit to, using 1 particle:</span></span></span>
<span class="r-in"><span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="va">gen</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, step <span class="op">=</span> <span class="fl">0</span>, n_particles <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span></span></span>
<span class="r-in"><span><span class="va">day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">incidence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">true_history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">101</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">true_history</span><span class="op">[</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sir</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">day</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">state_start</span> <span class="op">&lt;-</span> <span class="va">sir</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">sir</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">i</span> <span class="op">/</span> <span class="va">dt</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">state_end</span> <span class="op">&lt;-</span> <span class="va">sir</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">true_history</span><span class="op">[</span>, <span class="fl">1</span>, <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">state_end</span></span></span>
<span class="r-in"><span>  <span class="co"># Reduction in S</span></span></span>
<span class="r-in"><span>  <span class="va">incidence</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">state_start</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">state_end</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Convert this into our required format:</span></span></span>
<span class="r-in"><span><span class="va">data_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>day <span class="op">=</span> <span class="va">day</span>, incidence <span class="op">=</span> <span class="va">incidence</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="particle_filter_data.html">particle_filter_data</a></span><span class="op">(</span><span class="va">data_raw</span>, <span class="st">"day"</span>, <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># A comparison function</span></span></span>
<span class="r-in"><span><span class="va">compare</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">observed</span>, <span class="va">pars</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">exp_noise</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">exp_noise</span> <span class="op">&lt;-</span> <span class="fl">1e6</span></span></span>
<span class="r-in"><span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">exp_noise</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">$</span><span class="va">exp_noise</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="va">incidence_modelled</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">incidence_observed</span> <span class="op">&lt;-</span> <span class="va">observed</span><span class="op">$</span><span class="va">incidence</span></span></span>
<span class="r-in"><span>  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">incidence_modelled</span> <span class="op">+</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">incidence_modelled</span><span class="op">)</span>, <span class="va">exp_noise</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">incidence_observed</span>, <span class="va">lambda</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Construct the particle_filter object with 100 particles</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">particle_filter</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">data</span>, <span class="va">gen</span>, <span class="fl">100</span>, <span class="va">compare</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>save_history <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] -17844.23</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Our simulated trajectories, with the "real" data superimposed</span></span></span>
<span class="r-in"><span><span class="va">history</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">history</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">data_raw</span><span class="op">$</span><span class="va">day</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">history</span><span class="op">[</span><span class="fl">1</span>, , <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>,</span></span>
<span class="r-in"><span>        xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"State"</span>,</span></span>
<span class="r-in"><span>        col <span class="op">=</span> <span class="st">"#ff000022"</span>, lty <span class="op">=</span> <span class="fl">1</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">data_raw</span><span class="op">$</span><span class="va">day</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">history</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"#ffff0022"</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">data_raw</span><span class="op">$</span><span class="va">day</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">history</span><span class="op">[</span><span class="fl">3</span>, , <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"#0000ff22"</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matpoints</a></span><span class="op">(</span><span class="va">data_raw</span><span class="op">$</span><span class="va">day</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">true_history</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, , <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>,</span></span>
<span class="r-in"><span>          col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"yellow"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="particle_filter-1.png" alt="" width="700" height="433"></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Rich FitzJohn, Marc Baguelin, Edward Knock, Lilith Whittles, John Lees, Raphael Sonabend.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>

