<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Deterministic particle likelihood — particle_deterministic • mcstate</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Deterministic particle likelihood — particle_deterministic" />
<meta property="og:description" content="Create a deterministic version of the
particle_filter object, which runs a single
particle deterministically." />
<meta property="og:image" content="/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcstate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6.17</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/deterministic.html">Deterministic models</a>
    </li>
    <li>
      <a href="../articles/if2.html">Inference with iterated filtering</a>
    </li>
    <li>
      <a href="../articles/kalman.html">Validation of SMC using a Kalman filter</a>
    </li>
    <li>
      <a href="../articles/nested_sir_models.html">Nested SIR Models</a>
    </li>
    <li>
      <a href="../articles/parallelisation.html">Parallelisation of inference</a>
    </li>
    <li>
      <a href="../articles/restart.html">Restarting pMCMC</a>
    </li>
    <li>
      <a href="../articles/sir_models.html">SIR models with odin, dust and mcstate</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/mrc-ide/mcstate/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Deterministic particle likelihood</h1>
    <small class="dont-index">Source: <a href='https://github.com/mrc-ide/mcstate/blob/master/R/deterministic.R'><code>R/deterministic.R</code></a></small>
    <div class="hidden name"><code>particle_deterministic.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Create a deterministic version of the
<code><a href='particle_filter.html'>particle_filter</a></code> object, which runs a single
particle deterministically.</p>
    </div>



    <h2 class="hasAnchor" id="public-fields"><a class="anchor" href="#public-fields"></a>Public fields</h2>

    <p><div class="r6-fields"></p><dl>
<dt><code>model</code></dt><dd><p>The dust model generator being simulated (cannot be
re-bound)</p></dd>

</dl><p></div></p>
    <h2 class="hasAnchor" id="methods"><a class="anchor" href="#methods"></a>Methods</h2>

    
<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Public methods</h3>

<ul>
<li><p><a href='#method-new'><code>particle_deterministic$new()</code></a></p></li>
<li><p><a href='#method-run'><code>particle_deterministic$run()</code></a></p></li>
<li><p><a href='#method-run_many'><code>particle_deterministic$run_many()</code></a></p></li>
<li><p><a href='#method-state'><code>particle_deterministic$state()</code></a></p></li>
<li><p><a href='#method-history'><code>particle_deterministic$history()</code></a></p></li>
<li><p><a href='#method-restart_state'><code>particle_deterministic$restart_state()</code></a></p></li>
<li><p><a href='#method-inputs'><code>particle_deterministic$inputs()</code></a></p></li>
<li><p><a href='#method-set_n_threads'><code>particle_deterministic$set_n_threads()</code></a></p></li>
</ul>
<p><hr>
<a id="method-new"></a></p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method <code>new()</code></h3>
<p>Create the particle filter</p><h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Usage</h4>
<p><div class="r"></p><pre><span class='va'>particle_deterministic</span><span class='op'>$</span><span class='fu'>new</span><span class='op'>(</span>
  <span class='va'>data</span>,
  <span class='va'>model</span>,
  <span class='va'>compare</span>,
  index <span class='op'>=</span> <span class='cn'>NULL</span>,
  initial <span class='op'>=</span> <span class='cn'>NULL</span>,
  n_threads <span class='op'>=</span> <span class='fl'>1L</span>
<span class='op'>)</span></pre><p></div></p>

<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Arguments</h4>
<p><div class="arguments"></p><dl>
<dt><code>data</code></dt><dd><p>The data set to be used for the particle filter,
created by <code><a href='particle_filter_data.html'>particle_filter_data()</a></code>. This is essentially
a <code><a href='https://rdrr.io/r/base/data.frame.html'>data.frame()</a></code> with at least columns <code>step_start</code>
and <code>step_end</code>, along with any additional data used in the
<code>compare</code> function, and additional information about how your
steps relate to time.</p></dd>

<dt><code>model</code></dt><dd><p>A stochastic model to use.  Must be a
<code>dust_generator</code> object.</p></dd>

<dt><code>compare</code></dt><dd><p>A comparison function.  Must take arguments
<code>state</code>, <code>observed</code> and <code>pars</code> as arguments (though the arguments
may have different names). <code>state</code> is the simulated model state
(a matrix with as many rows as there are state variables and as
many columns as there are particles, <code>data</code>
is a <code>list</code> of observed data corresponding to the current
time's row in the <code>data</code> object provided here in the
constructor.  <code>pars</code> is any additional parameters passed
through to the comparison function (via the <code>pars</code>
argument to <code>$run</code>). Alternatively, <code>compare</code> can be <code>NULL</code>
if your model provides a built-in compile compare function
(if <code>model$public_methods$has_compare()</code> is <code>TRUE</code>), which may
be faster.</p></dd>

<dt><code>index</code></dt><dd><p>An index function. This is used to compute the
"interesting" indexes of your model. It must be a function of
one argument, which will be the result of calling the
<code>$info()</code> method on your model. It should return a list
with elements <code>run</code> (indices to return at the end of each
run, passed through to your compare function) and <code>state</code>
(indices to return if saving state). These indices can overlap
but do not have to. This argument is optional but using it will
likely speed up your simulation if you have more than a few
states as it will reduce the amount of memory copied back and
forth.</p></dd>

<dt><code>initial</code></dt><dd><p>A function to generate initial conditions. If
given, then this function must accept 3 arguments: <code>info</code>
(the result of calling <code>$info()</code> as for <code>index</code>),
<code>n_particles</code> (the number of particles that the particle
filter is using) and <code>pars</code> (parameters passed in in the
<code>$run</code> method via the <code>pars</code> argument).  It
must return a list, which can have the elements <code>state</code>
(initial model state, passed to the particle filter - either a
vector or a matrix, and overriding the initial conditions
provided by your model) and <code>step</code> (the initial step,
overriding the first step of your data - this must occur within
your first epoch in your <code>data</code> provided to the
constructor, i.e., not less than the first element of
<code>step_start</code> and not more than <code>step_end</code>). Your function
can also return a vector or matrix of <code>state</code> and not alter
the starting step, which is equivalent to returning
<code>list(state = state, step = NULL)</code>.</p></dd>

<dt><code>n_threads</code></dt><dd><p>Number of threads to use when running the
simulation. Defaults to 1, and should not be set higher than the
number of cores available to the machine. This currently has no
effect as the simulation will be run in serial on a single
particle for now.</p></dd>

</dl><p></div></p>
<p><hr>
<a id="method-run"></a></p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method <code>run()</code></h3>
<p>Run the deterministic particle filter</p><h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Usage</h4>
<p><div class="r"></p><pre><span class='va'>particle_deterministic</span><span class='op'>$</span><span class='fu'>run</span><span class='op'>(</span>
  pars <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='op'>)</span>,
  save_history <span class='op'>=</span> <span class='cn'>FALSE</span>,
  save_restart <span class='op'>=</span> <span class='cn'>NULL</span>,
  min_log_likelihood <span class='op'>=</span> <span class='op'>-</span><span class='cn'>Inf</span>
<span class='op'>)</span></pre><p></div></p>

<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Arguments</h4>
<p><div class="arguments"></p><dl>
<dt><code>pars</code></dt><dd><p>A list representing parameters. This will be passed as
the <code>pars</code> argument to your model, to your <code>compare</code>
function, and (if using) to your <code>initial</code> function. It must
be an R list (not vector or <code>NULL</code>) because that is what a
dust model currently requires on initialisation or <code>$reset</code> - we
may relax this later. You may want to put your observation and
initial parameters under their own keys (e.g.,
<code>pars$initial$whatever</code>), but this is up to you. Extra keys
are silently ignored by dust models.</p></dd>

<dt><code>save_history</code></dt><dd><p>Logical, indicating if the history of all
particles should be saved. If saving history, then it can be
queried later with the <code>$history</code> method on the object.</p></dd>

<dt><code>save_restart</code></dt><dd><p>An integer vector of time points to save
restart infomation for. Not currently supported.</p></dd>

<dt><code>min_log_likelihood</code></dt><dd><p>Not currently supported, exists to match
the inteface with <a href='particle_filter.html'>particle_filter</a>. Providing a value
larger than -Inf will cause an error.</p></dd>

</dl><p></div></p>
<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Returns</h4>
<p>A single numeric value representing the log-likelihood
(<code>-Inf</code> if the model is impossible)</p>
<p><hr>
<a id="method-run_many"></a></p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method <code>run_many()</code></h3>
<p>Run the deterministic particle filter on several
parameter sets simultaneously. This acts as a wrapper around
<code>$run()</code>, though runs will be in parallel if the object was created
with <code>n_threads</code> greater than 1.</p><h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Usage</h4>
<p><div class="r"></p><pre><span class='va'>particle_deterministic</span><span class='op'>$</span><span class='fu'>run_many</span><span class='op'>(</span>
  <span class='va'>pars</span>,
  save_history <span class='op'>=</span> <span class='cn'>FALSE</span>,
  save_restart <span class='op'>=</span> <span class='cn'>NULL</span>,
  min_log_likelihood <span class='op'>=</span> <span class='op'>-</span><span class='cn'>Inf</span>
<span class='op'>)</span></pre><p></div></p>

<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Arguments</h4>
<p><div class="arguments"></p><dl>
<dt><code>pars</code></dt><dd><p>A list of parameter sets, each element of which would
be suitable to pass to <code>$run()</code></p></dd>

<dt><code>save_history</code></dt><dd><p>Logical, indicating if the history of all
particles should be saved.</p></dd>

<dt><code>save_restart</code></dt><dd><p>An integer vector of time points to save
restart infomation for. Not currently supported.</p></dd>

<dt><code>min_log_likelihood</code></dt><dd><p>Not currently supported, exists to match
the inteface with <a href='particle_filter.html'>particle_filter</a>. Providing a value
larger than -Inf will cause an error.</p></dd>

</dl><p></div></p>
<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Returns</h4>
<p>A numeric vector of values representing the log-likelihood
(<code>-Inf</code> if the model is impossible), one per parameter set</p>
<p><hr>
<a id="method-state"></a></p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method <code><a href='https://rdrr.io/r/datasets/state.html'>state()</a></code></h3>
<p>Extract the current model state, optionally filtering.
If the model has not yet been run, then this method will throw an
error. Returns a matrix with the number of rows being the number of
model states, and the number of columns being the number of
particles.</p><h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Usage</h4>
<p><div class="r"></p><pre><span class='va'>particle_deterministic</span><span class='op'>$</span><span class='fu'>state</span><span class='op'>(</span>index_state <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span></pre><p></div></p>

<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Arguments</h4>
<p><div class="arguments"></p><dl>
<dt><code>index_state</code></dt><dd><p>Optional vector of states to extract</p></dd>

</dl><p></div></p>
<p><hr>
<a id="method-history"></a></p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method <code><a href='https://rdrr.io/r/utils/savehistory.html'>history()</a></code></h3>
<p>Extract the particle trajectories. Requires that
the model was run with <code>save_history = TRUE</code>, which does
incur a performance cost. This method will throw an error if
the model has not run, or was run without <code>save_history = TRUE</code>. Returns a 3d array with dimensions corresponding to (1)
model state, filtered by <code>index$run</code> if provided, (2)
particle (following <code>index_particle</code> if provided), (3)
time point.</p><h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Usage</h4>
<p><div class="r"></p><pre><span class='va'>particle_deterministic</span><span class='op'>$</span><span class='fu'>history</span><span class='op'>(</span>index_particle <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span></pre><p></div></p>

<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Arguments</h4>
<p><div class="arguments"></p><dl>
<dt><code>index_particle</code></dt><dd><p>Optional vector of particle indices to return.
If <code>NULL</code> we return all particles' histories.</p></dd>

</dl><p></div></p>
<p><hr>
<a id="method-restart_state"></a></p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method <code>restart_state()</code></h3>
<p>Return the full particle filter state at points back in time
that were saved with the <code>save_restart</code> argument to
<code>$run()</code>. If available, this will return a 3d array, with
dimensions representing (1) particle state, (2) particle index,
(3) time point. If nested parameters are used then returns a 4d array,
with dimensions representing (1) particle state, (2) particle index,
(3) population, (4) time point. This could be quite large, especially
if you are using the <code>index</code> argument to create the particle filter
and return a subset of all state generally. In the stochastic version,
this is different the saved trajectories returned by <code>$history()</code>
because earlier saved state is not filtered by later filtering,
but in the deterministic model we run with a single particle so it
<em>is</em> the same.</p><h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Usage</h4>
<p><div class="r"></p><pre><span class='va'>particle_deterministic</span><span class='op'>$</span><span class='fu'>restart_state</span><span class='op'>(</span>index_particle <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span></pre><p></div></p>

<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Arguments</h4>
<p><div class="arguments"></p><dl>
<dt><code>index_particle</code></dt><dd><p>Optional vector of particle indices to return.
If <code>NULL</code> we return all particles' states. Practically because the
only valid value of index_particle is "1", this has no effect and
it is included primarily for compatibility with the stochastic
interface.</p></dd>

</dl><p></div></p>
<p><hr>
<a id="method-inputs"></a></p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method <code>inputs()</code></h3>
<p>Return a list of inputs used to configure the deterministic particle
filter. These correspond directly to the argument names for the
constructor and are the same as the input arguments.</p><h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Usage</h4>
<p><div class="r"></p><pre><span class='va'>particle_deterministic</span><span class='op'>$</span><span class='fu'>inputs</span><span class='op'>(</span><span class='op'>)</span></pre><p></div></p>

<p><hr>
<a id="method-set_n_threads"></a></p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Method <code>set_n_threads()</code></h3>
<p>Set the number of threads used by the particle filter (and dust
model) after creation. This can be used to allocate additional
(or subtract excess) computing power from the deterministic filter
Returns (invisibly) the previous value.</p><h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Usage</h4>
<p><div class="r"></p><pre><span class='va'>particle_deterministic</span><span class='op'>$</span><span class='fu'>set_n_threads</span><span class='op'>(</span><span class='va'>n_threads</span><span class='op'>)</span></pre><p></div></p>

<h4 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Arguments</h4>
<p><div class="arguments"></p><dl>
<dt><code>n_threads</code></dt><dd><p>The new number of threads to use. You may want to
wrap this argument in <code><a href='https://rdrr.io/pkg/dust/man/dust_openmp_threads.html'>dust::dust_openmp_threads()</a></code> in order to
verify that you can actually use the number of threads
requested (based on environment variables and OpenMP support).</p></dd>

</dl><p></div></p>



  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Rich FitzJohn, Marc Baguelin, Edward Knock, Lilith Whittles, John Lees, Raphael Sonabend.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


